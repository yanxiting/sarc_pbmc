---
title: "FastQC on bulk RNAseq data"
author: "Xiting Yan"
date: "05/25/2021"
output:
  html_notebook:
    code_folding: hide
    fig_caption: yes
    highlight: tango
    number_sections: no
    theme: united
    toc: yes
    toc_depth: 6
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval=TRUE,echo = TRUE,cache=TRUE,warning=FALSE,message = FALSE,results='hold',cache.lazy = FALSE)
knitr::opts_knit$set(eval.after = 'fig.cap',dev=c('png','postscript'))

library(kableExtra)
library(gdata)
library(knitr)
library(captioner)
library(nlme)
library(rgl)
library(gplots)

knit_hooks$set(webgl = hook_webgl)


table_nums_1 <- captioner::captioner(prefix="Table",levels=1)
figure_nums_1<- captioner::captioner(prefix="Figure",levels=1)


table_nums_2 <- captioner::captioner(prefix="Table",levels=2)
figure_nums_2<- captioner::captioner(prefix="Figure",levels=2)

table_nums_3 <- captioner::captioner(prefix="Table",levels=3)
figure_nums_3 <- captioner::captioner(prefix="Figure",levels=3)

#home.dir<-"/home/yanxiting/driver_Grace"
home.dir<-"/home/xy48"
source(paste(home.dir,"/Rprogram/my_functions.R",sep=""))
output.dir<-file.path(home.dir,"scratch/GRADS/SARC_results/Results_summary_PBMC_hg38")
```


# Background
In this note, we demonstrate how to use R to generate sh file to run FastQC on a given list of fastq files. There are two styles to run the jobs. 
* Run Cutadapt on different samples in parallele (style 1).
* Run Cutadapt on different samples in one thread (style 2).

# FastQC

## Apply FastQC
Input for this style includes:

* data.dir: folder containing a list of folders, each of which contains fastq files for a given sample. no other files should exist under these folders other than the fastq.gz files.
* work.dir: folder where to save the scripts and the FastQC results.
* fastq.filepath: location of the executable file for FastQC.

```{r eval=FALSE}
# This chunck needs to be run on the hpc.
# Since our samples were saved in two different folders, we run this chunck for each data.dir separately.
#data.dir<-"/home/xy48/scratch/Shervin/data/sample_dir_000005540"
work.dir<-file.path(home.dir,"scratch60/Laura_Koth")
data.dir<-file.path(work.dir,"fastq")

fastqc.filepath<-"/home/xy48/scratch_kaminski/public/softwares/FastQC_v0.11.5/fastqc" # This has to be a location on the hpc.

script.dir<-file.path(work.dir,"scripts_FastQC")
output.dir<-file.path(work.dir,"results_FastQC")

if(file.exists(script.dir)==F){
  dir.create(script.dir)
}

if(file.exists(output.dir)==F){
  dir.create(output.dir)
}

jobsub.filepath<-file.path(script.dir,"jobsub.bat")
if(file.exists(jobsub.filepath)){
  file.remove(jobsub.filepath)
}
file.create(jobsub.filepath)

# get the list of folders under data.dir
filenames<-list.files(data.dir)

# we generate one sh file for each sample separately.
for(i in 1:length(filenames)){
  sample.name<-my.element.extract(filenames[i],splitchar="\\.",index=1)
  script.filepath<-file.path(script.dir,paste(sample.name,".sh",sep=""))
  output.subdir<-file.path(output.dir,sample.name)
  if(file.exists(output.subdir)==F){
    dir.create(output.subdir)
  }
  
  # generate the header for the sh file
  cmd.out<-"#!/bin/bash\n"
  cmd.out<-paste(cmd.out,"#SBATCH --partition=day,pi_kaminski\n",sep="")
  cmd.out<-paste(cmd.out,"#SBATCH --job-name=",sample.name,"\n",sep="")
  cmd.out<-paste(cmd.out,"#SBATCH --ntasks=1\n",sep="")
  cmd.out<-paste(cmd.out,"#SBATCH --cpus-per-task=10\n",sep="")
  cmd.out<-paste(cmd.out,"#SBATCH --mem-per-cpu=10G\n",sep="")
  cmd.out<-paste(cmd.out,"#SBATCH --time=1-00:00:00\n",sep="")
  
  fastq.filepath<-file.path(data.dir,filenames[i])
  temp<-paste(fastqc.filepath," -o ",output.subdir," -t 10 ",fastq.filepath,"\n",sep="")
  cmd.out<-paste(cmd.out,paste(temp,collapse="\n"),sep="")
  cat(cmd.out,file=script.filepath,append=F)
  
  cat("sbatch < ",script.filepath,"\n",sep="",file=jobsub.filepath,append=T)
}
system(paste("chmod 700 ",jobsub.filepath,sep=""))

```

## FastQC Summary
We load in the results and generate a summary of the fastQC results.

First, we unzip the zip files generated by FastQC.
```{r}
# These codes were run directy on the HPC

# First, we unzip the FastQC report zip files
result.dir<-"/home/xy48/scratch/Shervin/results_FastQC"
sample.names<-list.files(result.dir)

for(i in 1:length(sample.names)){
  filenames<-list.files(file.path(result.dir,sample.names[i]))
  filenames<-filenames[grep(".zip",filenames)]
  for(j in 1:length(filenames)){
    unzip(file.path(result.dir,sample.names[i],filenames[j]),exdir=file.path(result.dir,sample.names[i]))
  }
}
```

Second, extract the results across different files and merge them into one single file.
```{r}
# These codes were run directy on the HPC
###########
# Second, we extract the results and export it into a spreadsheet.
source("~/Rprogram/my_functions.R")
result.dir<-"/home/xy48/scratch/Shervin/results_FastQC"
output.filepath<-"/home/xy48/scratch/Shervin/FastQC_results_table.txt"
sample.names<-list.files(result.dir)
cmd.out<-cmd.out<-data.frame()
filenames.vect<-character()


for(i in 1:length(sample.names)){
  
  result.subdir<-file.path(result.dir,sample.names[i])
  temp.dirs<-list.dirs(result.subdir,full.names=F,recursive = FALSE)
  input.filenames<-file.path(temp.dirs,"summary.txt")
  filenames.vect<-c(filenames.vect,temp.dirs)
  input.filepath<-file.path(result.subdir,input.filenames)
  
  my.data.1<-data.frame()
  for(j in 1:length(input.filepath)){
    temp.text<-as.matrix(read.table(input.filepath[j],sep="\t",header=F,check.names=F))
    temp.values<-temp.text[,1]
    names(temp.values)<-temp.text[,2]
    if(i==1 & j==1){
      my.rownames<-temp.text[,2]
    }
    my.data.1<-rbind(my.data.1,as.data.frame(t(temp.values)))
  }
  
  input.filenames<-file.path(temp.dirs,"fastqc_data.txt")
  input.filepath<-file.path(result.subdir,input.filenames)
  my.data<-data.frame()
  for(j in 1:length(input.filepath)){
    temp.text<-readLines(input.filepath[j])
    
    # extract the overrepresented sequences
    over.start<-grep(">>Overrepresented sequences",temp.text)
    adapter.start<-grep(">>Adapter Content",temp.text)
    file.end<-length(temp.text)
    
#    my.temp<-c(my.temp,my.element.extract(temp.text[over.start+2],splitchar="\t",index=1))
    my.temp<-data.frame(overrepresented_sequence=my.element.extract(temp.text[over.start+2],splitchar="\t",index=1))
    temp.names<-unlist(strsplit(temp.text[adapter.start+1],split="\t"))
    temp.values<-unlist(strsplit(temp.text[length(temp.text)-1],split="\t"))
    temp.values<-temp.values[-1]
    names(temp.values)<-temp.names[2:length(temp.names)]
    temp.values<-as.data.frame(t(temp.values))
    my.temp<-cbind(my.temp,temp.values)
    my.data<-rbind(my.data,my.temp)
  }

  my.data<-cbind(my.data.1,my.data)
  
  cmd.out<-rbind(cmd.out,my.data)
} 

temp1<-sapply(filenames.vect,my.element.extract,splitchar="_",index=1)
temp2<-sapply(filenames.vect,my.element.extract,splitchar="_",index=6)
rownames(cmd.out)<-paste(temp1,"_",temp2,sep="")

# load in the phenotype data table and add the protocol information into this results (optional)
pheno.filepath<-"/home/xy48/scratch/Shervin/pheno_data/phenotype_updated.txt"
pheno.table<-read.table(pheno.filepath,sep="\t",header=T,check.names=F)
protocol.vect<-as.matrix(pheno.table)[,"Protocol"]
names(protocol.vect)<-as.matrix(pheno.table)[,"Sample"]

temp1<-sapply(rownames(cmd.out),my.element.extract,splitchar="_",index=1)
cmd.out<-cbind(cmd.out,protocol.vect[temp1])
colnames(cmd.out)[ncol(cmd.out)]<-"protocol"

# output the table
cat("filenames\t",file=output.filepath,append=F)
write.table(cmd.out,file=output.filepath,sep="\t",row.names=T,col.names=T,quote=F,append=T)
```

